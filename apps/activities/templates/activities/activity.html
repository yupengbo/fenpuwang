{% extends "base_no_nav.html" %}

{% block keywords %} 春节红包发！发！发！ -粉扑网 {% endblock %}
{% block description %} 分享内容换取红包 -粉扑网 {% endblock %}
{% block title %} 春节红包发！发！发！ {% endblock %}
{% block script %}
    {% load static %}
	<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script type="text/javascript" src="{% static "js/jquery.min.js" %}"></script>
{% endblock %}
{% block main_content %}
<div style='display:{% if not session %}block{% else %}none{% endif %};'>
去授权的页面
</div>
<div style='display:{% if session %}block{% else %}none{% endif %};'>
授权回来：{{ session }}
<div style='display:{% if session %}block{% else %}none{% endif %};'>
<input type='button' value='打开红包' onclick='open_bonus()'/>
</div>
<div style='display:{% if session %}block{% else %}none{% endif %};'>
4
</div>
</div>
<script>
function addCookie(objName,objValue,objHours){//添加cookie
    var str = objName + "=" + escape(objValue);
    if(objHours > 0){//为0时不设定过期时间，浏览器关闭时cookie自动消失
        var date = new Date();
        var ms = objHours*3600*1000;
        date.setTime(date.getTime() + ms);
        str += "; expires=" + date.toGMTString();
     }
     document.cookie = str;
}

function getCookie(objName){//获取指定名称的cookie的值
    var arrStr = document.cookie.split("; ");
    for(var i = 0;i < arrStr.length;i ++){
        var temp = arrStr[i].split("=");
        if(temp[0] == objName) return unescape(temp[1]);
    }
}
$.extend({
   get_data: function (url, args, success_cb, completion_cb, datatype) {
         datatype = (datatype == null ? 'text' : datatype.toUpperCase());
         success_cb = (success_cb === null ? $.success_callback : success_cb);
         completion_cb = (completion_cb === null ? $.complete_callback : completion_cb);
         $.ajax({
             type: 'POST',
             dataType: datatype.toLowerCase(),
             url: url,
             data: args,
             timeout: 10000,
             async: true,
             cache: true,
             beforeSend: $.before_send_callback,
             complete: completion_cb,
             success: success_cb,
             error: $.error_callback
         });
   },
   success_callback: function (xmlReq) {
        $.ajax_complete();
   },
   before_send_callback: function (xmlReq) {
   },
   complete_callback: function (xmlReq, textStatus) {
      /**
      * 数据获取完成时执行
      */
   },
      /**
	  * 请求出现错误 responseText 请求的数据 data || textStatus 文本状态 eg：success
	  */
   error_callback: function (xmlReq, textStatus) {
       switch (xmlReq.status) {
	      case 404: // Not Found
		     alert("XmlHttpRequest status: [404] \nThe requested URL was not found on this server.");
		     break;
          case 500:
	         alert("XmlHttpRequest status: [500] Service Unavailable");
		 	 break;
		  case 400:
			 alert("XmlHttpRequest status: [400] Bad Request");
		     break;
		  case 503: // Service Unavailable
			 alert("XmlHttpRequest status: [503] Service Unavailable");
			 break;
		  default:
			 break;
		}
   }
});
//addCookie('xx',1,7*24);
wx.onMenuShareTimeline({
    title: '', // 分享标题
    link: '', // 分享链接
    imgUrl: '', // 分享图标
    success: function () { 
        // 用户确认分享后执行的回调函数
		share_activity();
    },
    cancel: function () { 
    // 用户取消分享后执行的回调函数
    }
});
function share_activity(){
  $.get_data(
     '{%  url 'activities:share_activity' activity_id %}',
	      "",
     function(data) {
	   if(data['error']==0){
	      alert(2);
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
  );
}
function open_bonus(){  
  $.get_data(
     'http://www.meizhi.so/{%  url 'activities:open_bonus' activity_id %}',
	      "rand="+Math.random(),
     function(data) {
	   if(data['error']==0){
	      alert(1);
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
  );
}
{% if not session %}
$.get_data(
     '{%  url 'activities:wx_auth' activity_id %}',
	      "rand="+Math.random(),
     function(data) {
	   alert(data['uri']);
	   if(data['uri']){
	      window.location=data['uri'];
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
);
  alert("无session");
{% else %}
  alert("重写{{ session }}");
  addCookie('session','{{ session }}',7*24);
{% endif %}
alert(getCookie('session'));
</script>
{% endblock %}



{% extends "base_no_nav.html" %}

{% block keywords %} 春节红包发！发！发！ -粉扑网 {% endblock %}
{% block description %} 分享内容换取红包 -粉扑网 {% endblock %}
{% block title %} 春节红包发！发！发！ {% endblock %}
{% block script %}
    {% load static %}
	<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script type="text/javascript" src="{% static "js/jquery.min.js" %}"></script>
{% endblock %}
{% block main_content %}
<div style='display:{% if not session %}block{% else %}none{% endif %};'>
去授权的页面
</div>
<div style='display:{% if session %}block{% else %}none{% endif %};'>
授权回来：{{ session }}<br/>
分享收益：{{ share_activity_fee }}<br/>
红包收益：{{ bonus_fee }}<br/>
appId: '{{ appid }}',
timestamp: {{ timestamp }},
nonceStr: '{{ nonceStr }}',
signature: '{{ signature }}',
<div style='display:{% if session %}block{% else %}none{% endif %};'>
<input type='button' value='打开红包' onclick='open_bonus()'/>
</div>
<div style='display:{% if session %}block{% else %}none{% endif %};'>
4
</div>
</div>
<script>

wx.config({
      debug: true,
      appId: '{{ appid }}',
      timestamp: {{ timestamp }},
      nonceStr: '{{ nonceStr }}',
      signature: '{{ signature }}',
      jsApiList: [
        'checkJsApi',
        'onMenuShareTimeline',
        'onMenuShareAppMessage',
        'onMenuShareQQ',
        'onMenuShareWeibo'
     ]
});

wx.ready(function(){
wx.onMenuShareTimeline({
    title: '', // 分享标题
    link: '', // 分享链接
    imgUrl: '', // 分享图标
    success: function () { 
        // 用户确认分享后执行的回调函数
		share_activity();
    },
    cancel: function () { 
    // 用户取消分享后执行的回调函数
    }
});

wx.onMenuShareAppMessage({
    title: '', // 分享标题
    desc: '', // 分享描述
    link: '', // 分享链接
    imgUrl: '', // 分享图标
    type: '', // 分享类型,music、video或link，不填默认为link
    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
    success: function () { 
    // 用户确认分享后执行的回调函数
	  alert(2);
	  share_activity();
    },
    cancel: function () { 
    // 用户取消分享后执行的回调函数
    }
});
});
function share_activity(){
  $.get_data(
     '{%  url 'activities:share_activity' activity_id %}',
	      "",
     function(data) {
	   if(data['error']==0){
	      alert(2);
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
  );
}

function open_bonus(){  
  $.get_data(
     '{%  url 'activities:open_bonus' activity_id %}',
	      "rand="+Math.random(),
     function(data) {
	   if(data['error']==0){
	      alert(1);
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
  );
}
{% if not session %}
$.get_data(
     '{%  url 'activities:wx_auth' activity_id %}',
	      "rand="+Math.random(),
     function(data) {
	   alert(data['uri']);
	   if(data['uri']){
	      window.location=data['uri'];
	   }
	 },
     function(xmlReq, textStatus) {
	 },
     'json'
);
  alert("无session");
{% else %}
  alert("重写{{ session }}");
  addCookie('session','{{ session }}', 0);
{% endif %}
alert(getCookie('session'));
</script>
{% endblock %}


